import _defineProperty from "@babel/runtime/helpers/esm/defineProperty";

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { _defineProperty(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }

import ScrollMagic from "./scrollmagic-with-ssr";
import throttle from 'lodash.throttle';
import { errorLog, isObject, scrollAnimationInit } from "./helpers";
var nameSpace = 'ScrollScene';

var updateTweenProgress = function updateTweenProgress(Scene, Tween, gsapForwardSpeed, gsapReverseSpeed) {
  if (Tween) {
    var progress = Scene.progress();
    var state = Scene.state();

    if (Tween.repeat && Tween.repeat() === -1) {
      if (state === 'DURING' && Tween.paused()) {
        Tween.timeScale(gsapForwardSpeed).play();
      } else if (state !== 'DURING' && !Tween.paused()) {
        Tween.pause();
      }
    } else if (progress != Tween.progress()) {
      if (Scene.duration() === 0) {
        if (progress > 0) {
          Tween.timeScale(gsapForwardSpeed).play();
        } else {
          Tween.timeScale(gsapReverseSpeed).reverse();
        }
      } else {
        Tween.progress(progress).pause();
      }
    }
  }
};

var removeTween = function removeTween(Tween) {
  if (Tween) {
    Tween.pause(0);
    Tween.kill();
  }
};

var setDuration = function setDuration(Scene, duration) {
  if (duration instanceof HTMLElement) {
    var previousHeight;
    var currentHeight;

    var getHeight = function getHeight() {
      return duration.offsetHeight;
    };

    var update = function update() {
      Scene.duration(getHeight());
      previousHeight = getHeight();
    };

    var fn = function fn() {
      currentHeight = getHeight();

      if (currentHeight !== previousHeight) {
        update();
      }
    };

    fn();
    window.addEventListener('resize', throttle(fn, 700));
    currentHeight = getHeight();
    update();
  } else if (isObject(duration)) {
    var keys = Object.keys(duration).reverse();

    var _fn = function _fn() {
      for (var index = 0; index < keys.length; index++) {
        var breakpoint = parseFloat(keys[index]);

        if (breakpoint <= window.innerWidth) {
          Scene.duration(duration[breakpoint]);
          break;
        }
      }
    };

    _fn();

    window.addEventListener('resize', throttle(_fn, 700));
  } else {
    Scene.duration(duration);
  }
};

var setClassName = function setClassName(Scene, options, duration) {
  var toggle = _objectSpread({
    className: null,
    element: null,
    reverse: false
  }, options);

  if (!toggle.className) {
    errorLog(nameSpace, "Be sure to set a className in the new ".concat(nameSpace, "({ toggle: { className: \"my-class\" } })"));
  }

  if (!toggle.element) {
    errorLog(nameSpace, "Be sure to set a const toggleElement = (reactRef.current or document.querySelector) in the new ".concat(nameSpace, "({ toggle: { element: toggleElement } })"));
  }

  var addClassName = function addClassName() {
    return !toggle.element.classList.contains(toggle.className) && toggle.element.classList.add(toggle.className);
  };

  var removeClassName = function removeClassName() {
    return toggle.element.classList.contains(toggle.className) && toggle.element.classList.remove(toggle.className);
  };

  Scene.on('enter', function () {
    addClassName();
  });
  Scene.on('add', function () {
    if (Scene.state() === 'DURING') {
      addClassName();
    }
  });
  Scene.on('leave', function (event) {
    if (!toggle.reverse && duration) {
      event.scrollDirection === 'REVERSE' && removeClassName();
    } else {
      removeClassName();
    }
  });
  Scene.on('remove', function () {
    removeClassName();
  });
};

var setTween = function setTween(Scene, options) {
  var gsap = _objectSpread({
    forwardSpeed: 1,
    reverseSpeed: 1,
    timeline: null
  }, options);

  if (!gsap.timeline) {
    errorLog(nameSpace, "Be sure to set a const tl = gsap.timeline({ paused: true }) in the new ".concat(nameSpace, "({ gsap: { timeline: tl } })"));
  }

  Scene.on('progress', function () {
    updateTweenProgress(Scene, gsap.timeline, gsap.forwardSpeed, gsap.reverseSpeed);
  });
  Scene.on('remove', function () {
    removeTween(gsap.timeline);
  });
};

var globalController;

var ScrollScene = function ScrollScene(_ref) {
  var breakpoints = _ref.breakpoints,
      _ref$controller = _ref.controller,
      controller = _ref$controller === void 0 ? {} : _ref$controller,
      duration = _ref.duration,
      gsap = _ref.gsap,
      _ref$offset = _ref.offset,
      offset = _ref$offset === void 0 ? 0 : _ref$offset,
      _ref$scene = _ref.scene,
      scene = _ref$scene === void 0 ? {} : _ref$scene,
      toggle = _ref.toggle,
      triggerElement = _ref.triggerElement,
      _ref$triggerHook = _ref.triggerHook,
      triggerHook = _ref$triggerHook === void 0 ? 'onEnter' : _ref$triggerHook,
      _ref$useGlobalControl = _ref.useGlobalController,
      useGlobalController = _ref$useGlobalControl === void 0 ? true : _ref$useGlobalControl;
  var localController;

  if (!useGlobalController) {
    localController = new ScrollMagic.Controller(controller);
  }

  if (!globalController && useGlobalController) {
    globalController = new ScrollMagic.Controller(controller);
  }

  var controllerIsUse = localController ? localController : globalController;

  if (!triggerElement) {
    errorLog(nameSpace, "Be sure to set a const triggerElement = (reactRef.current or document.querySelector) in the new ".concat(nameSpace, "({ triggerElement: triggerElement })."));
  }

  var Scene = new ScrollMagic.Scene(_objectSpread({
    triggerElement: triggerElement,
    triggerHook: triggerHook,
    offset: offset
  }, scene));

  if (duration) {
    setDuration(Scene, duration);
  }

  if (toggle && isObject(toggle)) {
    setClassName(Scene, toggle, duration);
  }

  if (gsap && isObject(gsap)) {
    setTween(Scene, gsap);
  }

  this.init = function () {
    controllerIsUse && Scene.addTo(controllerIsUse);
  };

  this.destroy = function () {
    Scene.remove();
  };

  this.Scene = Scene;
  this.Controller = controllerIsUse;
  scrollAnimationInit(breakpoints, this.init, this.destroy);
};

export { ScrollScene };
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9TY3JvbGxTY2VuZS50cyJdLCJuYW1lcyI6WyJTY3JvbGxNYWdpYyIsInRocm90dGxlIiwiZXJyb3JMb2ciLCJpc09iamVjdCIsInNjcm9sbEFuaW1hdGlvbkluaXQiLCJuYW1lU3BhY2UiLCJ1cGRhdGVUd2VlblByb2dyZXNzIiwiU2NlbmUiLCJUd2VlbiIsImdzYXBGb3J3YXJkU3BlZWQiLCJnc2FwUmV2ZXJzZVNwZWVkIiwicHJvZ3Jlc3MiLCJzdGF0ZSIsInJlcGVhdCIsInBhdXNlZCIsInRpbWVTY2FsZSIsInBsYXkiLCJwYXVzZSIsImR1cmF0aW9uIiwicmV2ZXJzZSIsInJlbW92ZVR3ZWVuIiwia2lsbCIsInNldER1cmF0aW9uIiwiSFRNTEVsZW1lbnQiLCJwcmV2aW91c0hlaWdodCIsImN1cnJlbnRIZWlnaHQiLCJnZXRIZWlnaHQiLCJvZmZzZXRIZWlnaHQiLCJ1cGRhdGUiLCJmbiIsIndpbmRvdyIsImFkZEV2ZW50TGlzdGVuZXIiLCJrZXlzIiwiT2JqZWN0IiwiaW5kZXgiLCJsZW5ndGgiLCJicmVha3BvaW50IiwicGFyc2VGbG9hdCIsImlubmVyV2lkdGgiLCJzZXRDbGFzc05hbWUiLCJvcHRpb25zIiwidG9nZ2xlIiwiY2xhc3NOYW1lIiwiZWxlbWVudCIsImFkZENsYXNzTmFtZSIsImNsYXNzTGlzdCIsImNvbnRhaW5zIiwiYWRkIiwicmVtb3ZlQ2xhc3NOYW1lIiwicmVtb3ZlIiwib24iLCJldmVudCIsInNjcm9sbERpcmVjdGlvbiIsInNldFR3ZWVuIiwiZ3NhcCIsImZvcndhcmRTcGVlZCIsInJldmVyc2VTcGVlZCIsInRpbWVsaW5lIiwiZ2xvYmFsQ29udHJvbGxlciIsIlNjcm9sbFNjZW5lIiwiYnJlYWtwb2ludHMiLCJjb250cm9sbGVyIiwib2Zmc2V0Iiwic2NlbmUiLCJ0cmlnZ2VyRWxlbWVudCIsInRyaWdnZXJIb29rIiwidXNlR2xvYmFsQ29udHJvbGxlciIsImxvY2FsQ29udHJvbGxlciIsIkNvbnRyb2xsZXIiLCJjb250cm9sbGVySXNVc2UiLCJpbml0IiwiYWRkVG8iLCJkZXN0cm95Il0sIm1hcHBpbmdzIjoiOzs7Ozs7QUFBQSxPQUFPQSxXQUFQO0FBQ0EsT0FBT0MsUUFBUCxNQUFxQixpQkFBckI7QUFDQSxTQUFTQyxRQUFULEVBQW1CQyxRQUFuQixFQUE2QkMsbUJBQTdCO0FBR0EsSUFBTUMsU0FBUyxHQUFHLGFBQWxCOztBQUVBLElBQU1DLG1CQUFtQixHQUFHLFNBQXRCQSxtQkFBc0IsQ0FBU0MsS0FBVCxFQUFnQkMsS0FBaEIsRUFBdUJDLGdCQUF2QixFQUF5Q0MsZ0JBQXpDLEVBQTJEO0FBQ3JGLE1BQUlGLEtBQUosRUFBVztBQUNULFFBQU1HLFFBQVEsR0FBR0osS0FBSyxDQUFDSSxRQUFOLEVBQWpCO0FBQ0EsUUFBTUMsS0FBSyxHQUFHTCxLQUFLLENBQUNLLEtBQU4sRUFBZDs7QUFDQSxRQUFJSixLQUFLLENBQUNLLE1BQU4sSUFBZ0JMLEtBQUssQ0FBQ0ssTUFBTixPQUFtQixDQUFDLENBQXhDLEVBQTJDO0FBRXpDLFVBQUlELEtBQUssS0FBSyxRQUFWLElBQXNCSixLQUFLLENBQUNNLE1BQU4sRUFBMUIsRUFBMEM7QUFDeENOLFFBQUFBLEtBQUssQ0FBQ08sU0FBTixDQUFnQk4sZ0JBQWhCLEVBQWtDTyxJQUFsQztBQUNELE9BRkQsTUFFTyxJQUFJSixLQUFLLEtBQUssUUFBVixJQUFzQixDQUFDSixLQUFLLENBQUNNLE1BQU4sRUFBM0IsRUFBMkM7QUFDaEROLFFBQUFBLEtBQUssQ0FBQ1MsS0FBTjtBQUNEO0FBQ0YsS0FQRCxNQU9PLElBQUlOLFFBQVEsSUFBSUgsS0FBSyxDQUFDRyxRQUFOLEVBQWhCLEVBQWtDO0FBR3ZDLFVBQUlKLEtBQUssQ0FBQ1csUUFBTixPQUFxQixDQUF6QixFQUE0QjtBQUUxQixZQUFJUCxRQUFRLEdBQUcsQ0FBZixFQUFrQjtBQUVoQkgsVUFBQUEsS0FBSyxDQUFDTyxTQUFOLENBQWdCTixnQkFBaEIsRUFBa0NPLElBQWxDO0FBQ0QsU0FIRCxNQUdPO0FBRUxSLFVBQUFBLEtBQUssQ0FBQ08sU0FBTixDQUFnQkwsZ0JBQWhCLEVBQWtDUyxPQUFsQztBQUNEO0FBQ0YsT0FURCxNQVNPO0FBR0xYLFFBQUFBLEtBQUssQ0FBQ0csUUFBTixDQUFlQSxRQUFmLEVBQXlCTSxLQUF6QjtBQUNEO0FBQ0Y7QUFDRjtBQUNGLENBOUJEOztBQWdDQSxJQUFNRyxXQUFXLEdBQUcsU0FBZEEsV0FBYyxDQUFTWixLQUFULEVBQWdCO0FBQ2xDLE1BQUlBLEtBQUosRUFBVztBQUNUQSxJQUFBQSxLQUFLLENBQUNTLEtBQU4sQ0FBWSxDQUFaO0FBQ0FULElBQUFBLEtBQUssQ0FBQ2EsSUFBTjtBQUNEO0FBQ0YsQ0FMRDs7QUFPQSxJQUFNQyxXQUFXLEdBQUcsU0FBZEEsV0FBYyxDQUFDZixLQUFELEVBQVFXLFFBQVIsRUFBcUI7QUFFdkMsTUFBSUEsUUFBUSxZQUFZSyxXQUF4QixFQUFxQztBQUNuQyxRQUFJQyxjQUFKO0FBQ0EsUUFBSUMsYUFBSjs7QUFFQSxRQUFNQyxTQUFTLEdBQUcsU0FBWkEsU0FBWTtBQUFBLGFBQU1SLFFBQVEsQ0FBQ1MsWUFBZjtBQUFBLEtBQWxCOztBQUVBLFFBQU1DLE1BQU0sR0FBRyxTQUFUQSxNQUFTLEdBQU07QUFDbkJyQixNQUFBQSxLQUFLLENBQUNXLFFBQU4sQ0FBZVEsU0FBUyxFQUF4QjtBQUNBRixNQUFBQSxjQUFjLEdBQUdFLFNBQVMsRUFBMUI7QUFDRCxLQUhEOztBQUtBLFFBQU1HLEVBQUUsR0FBRyxTQUFMQSxFQUFLLEdBQU07QUFFZkosTUFBQUEsYUFBYSxHQUFHQyxTQUFTLEVBQXpCOztBQUVBLFVBQUlELGFBQWEsS0FBS0QsY0FBdEIsRUFBc0M7QUFDcENJLFFBQUFBLE1BQU07QUFDUDtBQUNGLEtBUEQ7O0FBU0FDLElBQUFBLEVBQUU7QUFFRkMsSUFBQUEsTUFBTSxDQUFDQyxnQkFBUCxDQUF3QixRQUF4QixFQUFrQzlCLFFBQVEsQ0FBQzRCLEVBQUQsRUFBSyxHQUFMLENBQTFDO0FBRUFKLElBQUFBLGFBQWEsR0FBR0MsU0FBUyxFQUF6QjtBQUVBRSxJQUFBQSxNQUFNO0FBQ1AsR0EzQkQsTUEyQk8sSUFBSXpCLFFBQVEsQ0FBQ2UsUUFBRCxDQUFaLEVBQXdCO0FBRTdCLFFBQU1jLElBQUksR0FBR0MsTUFBTSxDQUFDRCxJQUFQLENBQVlkLFFBQVosRUFBc0JDLE9BQXRCLEVBQWI7O0FBRUEsUUFBTVUsR0FBRSxHQUFHLFNBQUxBLEdBQUssR0FBTTtBQUNmLFdBQUssSUFBSUssS0FBSyxHQUFHLENBQWpCLEVBQW9CQSxLQUFLLEdBQUdGLElBQUksQ0FBQ0csTUFBakMsRUFBeUNELEtBQUssRUFBOUMsRUFBa0Q7QUFDaEQsWUFBTUUsVUFBVSxHQUFHQyxVQUFVLENBQUNMLElBQUksQ0FBQ0UsS0FBRCxDQUFMLENBQTdCOztBQUVBLFlBQUlFLFVBQVUsSUFBSU4sTUFBTSxDQUFDUSxVQUF6QixFQUFxQztBQUNuQy9CLFVBQUFBLEtBQUssQ0FBQ1csUUFBTixDQUFlQSxRQUFRLENBQUNrQixVQUFELENBQXZCO0FBQ0E7QUFDRDtBQUNGO0FBQ0YsS0FURDs7QUFXQVAsSUFBQUEsR0FBRTs7QUFFRkMsSUFBQUEsTUFBTSxDQUFDQyxnQkFBUCxDQUF3QixRQUF4QixFQUFrQzlCLFFBQVEsQ0FBQzRCLEdBQUQsRUFBSyxHQUFMLENBQTFDO0FBQ0QsR0FsQk0sTUFrQkE7QUFFTHRCLElBQUFBLEtBQUssQ0FBQ1csUUFBTixDQUFlQSxRQUFmO0FBQ0Q7QUFDRixDQW5ERDs7QUFxREEsSUFBTXFCLFlBQVksR0FBRyxTQUFmQSxZQUFlLENBQUNoQyxLQUFELEVBQVFpQyxPQUFSLEVBQWlCdEIsUUFBakIsRUFBOEI7QUFDakQsTUFBTXVCLE1BQU07QUFDVkMsSUFBQUEsU0FBUyxFQUFFLElBREQ7QUFFVkMsSUFBQUEsT0FBTyxFQUFFLElBRkM7QUFHVnhCLElBQUFBLE9BQU8sRUFBRTtBQUhDLEtBSVBxQixPQUpPLENBQVo7O0FBT0EsTUFBSSxDQUFDQyxNQUFNLENBQUNDLFNBQVosRUFBdUI7QUFDckJ4QyxJQUFBQSxRQUFRLENBQUNHLFNBQUQsa0RBQXFEQSxTQUFyRCwrQ0FBUjtBQUNEOztBQUVELE1BQUksQ0FBQ29DLE1BQU0sQ0FBQ0UsT0FBWixFQUFxQjtBQUNuQnpDLElBQUFBLFFBQVEsQ0FDTkcsU0FETSwyR0FFNEZBLFNBRjVGLDhDQUFSO0FBSUQ7O0FBRUQsTUFBTXVDLFlBQVksR0FBRyxTQUFmQSxZQUFlO0FBQUEsV0FDbkIsQ0FBQ0gsTUFBTSxDQUFDRSxPQUFQLENBQWVFLFNBQWYsQ0FBeUJDLFFBQXpCLENBQWtDTCxNQUFNLENBQUNDLFNBQXpDLENBQUQsSUFBd0RELE1BQU0sQ0FBQ0UsT0FBUCxDQUFlRSxTQUFmLENBQXlCRSxHQUF6QixDQUE2Qk4sTUFBTSxDQUFDQyxTQUFwQyxDQURyQztBQUFBLEdBQXJCOztBQUdBLE1BQU1NLGVBQWUsR0FBRyxTQUFsQkEsZUFBa0I7QUFBQSxXQUN0QlAsTUFBTSxDQUFDRSxPQUFQLENBQWVFLFNBQWYsQ0FBeUJDLFFBQXpCLENBQWtDTCxNQUFNLENBQUNDLFNBQXpDLEtBQXVERCxNQUFNLENBQUNFLE9BQVAsQ0FBZUUsU0FBZixDQUF5QkksTUFBekIsQ0FBZ0NSLE1BQU0sQ0FBQ0MsU0FBdkMsQ0FEakM7QUFBQSxHQUF4Qjs7QUFHQW5DLEVBQUFBLEtBQUssQ0FBQzJDLEVBQU4sQ0FBUyxPQUFULEVBQWtCLFlBQVc7QUFDM0JOLElBQUFBLFlBQVk7QUFDYixHQUZEO0FBSUFyQyxFQUFBQSxLQUFLLENBQUMyQyxFQUFOLENBQVMsS0FBVCxFQUFnQixZQUFXO0FBQ3pCLFFBQUkzQyxLQUFLLENBQUNLLEtBQU4sT0FBa0IsUUFBdEIsRUFBZ0M7QUFDOUJnQyxNQUFBQSxZQUFZO0FBQ2I7QUFDRixHQUpEO0FBTUFyQyxFQUFBQSxLQUFLLENBQUMyQyxFQUFOLENBQVMsT0FBVCxFQUFrQixVQUFTQyxLQUFULEVBQWdCO0FBQ2hDLFFBQUksQ0FBQ1YsTUFBTSxDQUFDdEIsT0FBUixJQUFtQkQsUUFBdkIsRUFBaUM7QUFFL0JpQyxNQUFBQSxLQUFLLENBQUNDLGVBQU4sS0FBMEIsU0FBMUIsSUFBdUNKLGVBQWUsRUFBdEQ7QUFDRCxLQUhELE1BR087QUFDTEEsTUFBQUEsZUFBZTtBQUNoQjtBQUNGLEdBUEQ7QUFTQXpDLEVBQUFBLEtBQUssQ0FBQzJDLEVBQU4sQ0FBUyxRQUFULEVBQW1CLFlBQVc7QUFDNUJGLElBQUFBLGVBQWU7QUFDaEIsR0FGRDtBQUdELENBL0NEOztBQWlEQSxJQUFNSyxRQUFRLEdBQUcsU0FBWEEsUUFBVyxDQUFDOUMsS0FBRCxFQUFRaUMsT0FBUixFQUFvQjtBQUNuQyxNQUFNYyxJQUFJO0FBQ1JDLElBQUFBLFlBQVksRUFBRSxDQUROO0FBRVJDLElBQUFBLFlBQVksRUFBRSxDQUZOO0FBR1JDLElBQUFBLFFBQVEsRUFBRTtBQUhGLEtBSUxqQixPQUpLLENBQVY7O0FBT0EsTUFBSSxDQUFDYyxJQUFJLENBQUNHLFFBQVYsRUFBb0I7QUFDbEJ2RCxJQUFBQSxRQUFRLENBQ05HLFNBRE0sbUZBRW9FQSxTQUZwRSxrQ0FBUjtBQUlEOztBQUVERSxFQUFBQSxLQUFLLENBQUMyQyxFQUFOLENBQVMsVUFBVCxFQUFxQixZQUFXO0FBQzlCNUMsSUFBQUEsbUJBQW1CLENBQUNDLEtBQUQsRUFBUStDLElBQUksQ0FBQ0csUUFBYixFQUF1QkgsSUFBSSxDQUFDQyxZQUE1QixFQUEwQ0QsSUFBSSxDQUFDRSxZQUEvQyxDQUFuQjtBQUNELEdBRkQ7QUFJQWpELEVBQUFBLEtBQUssQ0FBQzJDLEVBQU4sQ0FBUyxRQUFULEVBQW1CLFlBQVc7QUFDNUI5QixJQUFBQSxXQUFXLENBQUNrQyxJQUFJLENBQUNHLFFBQU4sQ0FBWDtBQUNELEdBRkQ7QUFHRCxDQXRCRDs7QUF3SUEsSUFBSUMsZ0JBQUo7O0FBRUEsSUFBTUMsV0FBVyxHQUFHLFNBQWRBLFdBQWMsT0FjbEI7QUFBQSxNQVhFQyxXQVdGLFFBWEVBLFdBV0Y7QUFBQSw2QkFWRUMsVUFVRjtBQUFBLE1BVkVBLFVBVUYsZ0NBVmUsRUFVZjtBQUFBLE1BVEUzQyxRQVNGLFFBVEVBLFFBU0Y7QUFBQSxNQVJFb0MsSUFRRixRQVJFQSxJQVFGO0FBQUEseUJBUEVRLE1BT0Y7QUFBQSxNQVBFQSxNQU9GLDRCQVBXLENBT1g7QUFBQSx3QkFORUMsS0FNRjtBQUFBLE1BTkVBLEtBTUYsMkJBTlUsRUFNVjtBQUFBLE1BTEV0QixNQUtGLFFBTEVBLE1BS0Y7QUFBQSxNQUpFdUIsY0FJRixRQUpFQSxjQUlGO0FBQUEsOEJBSEVDLFdBR0Y7QUFBQSxNQUhFQSxXQUdGLGlDQUhnQixTQUdoQjtBQUFBLG1DQUZFQyxtQkFFRjtBQUFBLE1BRkVBLG1CQUVGLHNDQUZ3QixJQUV4QjtBQUNBLE1BQUlDLGVBQUo7O0FBR0EsTUFBSSxDQUFDRCxtQkFBTCxFQUEwQjtBQUN4QkMsSUFBQUEsZUFBZSxHQUFHLElBQUluRSxXQUFXLENBQUNvRSxVQUFoQixDQUEyQlAsVUFBM0IsQ0FBbEI7QUFDRDs7QUFHRCxNQUFJLENBQUNILGdCQUFELElBQXFCUSxtQkFBekIsRUFBOEM7QUFDNUNSLElBQUFBLGdCQUFnQixHQUFHLElBQUkxRCxXQUFXLENBQUNvRSxVQUFoQixDQUEyQlAsVUFBM0IsQ0FBbkI7QUFDRDs7QUFFRCxNQUFNUSxlQUFlLEdBQUdGLGVBQWUsR0FBR0EsZUFBSCxHQUFxQlQsZ0JBQTVEOztBQUVBLE1BQUksQ0FBQ00sY0FBTCxFQUFxQjtBQUNuQjlELElBQUFBLFFBQVEsQ0FDTkcsU0FETSw0R0FFNkZBLFNBRjdGLDJDQUFSO0FBSUQ7O0FBRUQsTUFBTUUsS0FBSyxHQUFHLElBQUlQLFdBQVcsQ0FBQ08sS0FBaEI7QUFDWnlELElBQUFBLGNBQWMsRUFBZEEsY0FEWTtBQUVaQyxJQUFBQSxXQUFXLEVBQVhBLFdBRlk7QUFHWkgsSUFBQUEsTUFBTSxFQUFOQTtBQUhZLEtBSVRDLEtBSlMsRUFBZDs7QUFPQSxNQUFJN0MsUUFBSixFQUFjO0FBQ1pJLElBQUFBLFdBQVcsQ0FBQ2YsS0FBRCxFQUFRVyxRQUFSLENBQVg7QUFDRDs7QUFFRCxNQUFJdUIsTUFBTSxJQUFJdEMsUUFBUSxDQUFDc0MsTUFBRCxDQUF0QixFQUFnQztBQUM5QkYsSUFBQUEsWUFBWSxDQUFDaEMsS0FBRCxFQUFRa0MsTUFBUixFQUFnQnZCLFFBQWhCLENBQVo7QUFDRDs7QUFFRCxNQUFJb0MsSUFBSSxJQUFJbkQsUUFBUSxDQUFDbUQsSUFBRCxDQUFwQixFQUE0QjtBQUMxQkQsSUFBQUEsUUFBUSxDQUFDOUMsS0FBRCxFQUFRK0MsSUFBUixDQUFSO0FBQ0Q7O0FBRUQsT0FBS2dCLElBQUwsR0FBWSxZQUFXO0FBQ3JCRCxJQUFBQSxlQUFlLElBQUk5RCxLQUFLLENBQUNnRSxLQUFOLENBQVlGLGVBQVosQ0FBbkI7QUFDRCxHQUZEOztBQUlBLE9BQUtHLE9BQUwsR0FBZSxZQUFXO0FBQ3hCakUsSUFBQUEsS0FBSyxDQUFDMEMsTUFBTjtBQUNELEdBRkQ7O0FBSUEsT0FBSzFDLEtBQUwsR0FBYUEsS0FBYjtBQUNBLE9BQUs2RCxVQUFMLEdBQWtCQyxlQUFsQjtBQUVBakUsRUFBQUEsbUJBQW1CLENBQUN3RCxXQUFELEVBQWMsS0FBS1UsSUFBbkIsRUFBeUIsS0FBS0UsT0FBOUIsQ0FBbkI7QUFDRCxDQW5FRDs7QUFxRUEsU0FBU2IsV0FBVCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBTY3JvbGxNYWdpYyBmcm9tICcuL3Njcm9sbG1hZ2ljLXdpdGgtc3NyJ1xuaW1wb3J0IHRocm90dGxlIGZyb20gJ2xvZGFzaC50aHJvdHRsZSdcbmltcG9ydCB7IGVycm9yTG9nLCBpc09iamVjdCwgc2Nyb2xsQW5pbWF0aW9uSW5pdCB9IGZyb20gJy4vaGVscGVycydcbmltcG9ydCB7IElTY3JvbGxPYnNlcnZlclRvZ2dsZSwgSVNjcm9sbE9ic2VydmVyR3NhcCB9IGZyb20gJy4vU2Nyb2xsT2JzZXJ2ZXInXG5cbmNvbnN0IG5hbWVTcGFjZSA9ICdTY3JvbGxTY2VuZSdcblxuY29uc3QgdXBkYXRlVHdlZW5Qcm9ncmVzcyA9IGZ1bmN0aW9uKFNjZW5lLCBUd2VlbiwgZ3NhcEZvcndhcmRTcGVlZCwgZ3NhcFJldmVyc2VTcGVlZCkge1xuICBpZiAoVHdlZW4pIHtcbiAgICBjb25zdCBwcm9ncmVzcyA9IFNjZW5lLnByb2dyZXNzKClcbiAgICBjb25zdCBzdGF0ZSA9IFNjZW5lLnN0YXRlKClcbiAgICBpZiAoVHdlZW4ucmVwZWF0ICYmIFR3ZWVuLnJlcGVhdCgpID09PSAtMSkge1xuICAgICAgLy8gaW5maW5pdGUgbG9vcCwgc28gbm90IGluIHJlbGF0aW9uIHRvIHByb2dyZXNzXG4gICAgICBpZiAoc3RhdGUgPT09ICdEVVJJTkcnICYmIFR3ZWVuLnBhdXNlZCgpKSB7XG4gICAgICAgIFR3ZWVuLnRpbWVTY2FsZShnc2FwRm9yd2FyZFNwZWVkKS5wbGF5KClcbiAgICAgIH0gZWxzZSBpZiAoc3RhdGUgIT09ICdEVVJJTkcnICYmICFUd2Vlbi5wYXVzZWQoKSkge1xuICAgICAgICBUd2Vlbi5wYXVzZSgpXG4gICAgICB9XG4gICAgfSBlbHNlIGlmIChwcm9ncmVzcyAhPSBUd2Vlbi5wcm9ncmVzcygpKSB7XG4gICAgICAvLyBkbyB3ZSBldmVuIG5lZWQgdG8gdXBkYXRlIHRoZSBwcm9ncmVzcz9cbiAgICAgIC8vIG5vIGluZmluaXRlIGxvb3AgLSBzbyBzaG91bGQgd2UganVzdCBwbGF5IG9yIGdvIHRvIGEgc3BlY2lmaWMgcG9pbnQgaW4gdGltZT9cbiAgICAgIGlmIChTY2VuZS5kdXJhdGlvbigpID09PSAwKSB7XG4gICAgICAgIC8vIHBsYXkgdGhlIGFuaW1hdGlvblxuICAgICAgICBpZiAocHJvZ3Jlc3MgPiAwKSB7XG4gICAgICAgICAgLy8gcGxheSBmcm9tIDAgdG8gMVxuICAgICAgICAgIFR3ZWVuLnRpbWVTY2FsZShnc2FwRm9yd2FyZFNwZWVkKS5wbGF5KClcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAvLyBwbGF5IGZyb20gMSB0byAwXG4gICAgICAgICAgVHdlZW4udGltZVNjYWxlKGdzYXBSZXZlcnNlU3BlZWQpLnJldmVyc2UoKVxuICAgICAgICB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICAvLyBnbyB0byBhIHNwZWNpZmljIHBvaW50IGluIHRpbWVcbiAgICAgICAgLy8ganVzdCBoYXJkIHNldCBpdFxuICAgICAgICBUd2Vlbi5wcm9ncmVzcyhwcm9ncmVzcykucGF1c2UoKVxuICAgICAgfVxuICAgIH1cbiAgfVxufVxuXG5jb25zdCByZW1vdmVUd2VlbiA9IGZ1bmN0aW9uKFR3ZWVuKSB7XG4gIGlmIChUd2Vlbikge1xuICAgIFR3ZWVuLnBhdXNlKDApXG4gICAgVHdlZW4ua2lsbCgpXG4gIH1cbn1cblxuY29uc3Qgc2V0RHVyYXRpb24gPSAoU2NlbmUsIGR1cmF0aW9uKSA9PiB7XG4gIC8qIGNoZWNrIGlmIGR1cmF0aW9uIGlzIHNldCBhcyBhbiBIVE1MRWxlbWVudCAqL1xuICBpZiAoZHVyYXRpb24gaW5zdGFuY2VvZiBIVE1MRWxlbWVudCkge1xuICAgIGxldCBwcmV2aW91c0hlaWdodFxuICAgIGxldCBjdXJyZW50SGVpZ2h0XG5cbiAgICBjb25zdCBnZXRIZWlnaHQgPSAoKSA9PiBkdXJhdGlvbi5vZmZzZXRIZWlnaHRcblxuICAgIGNvbnN0IHVwZGF0ZSA9ICgpID0+IHtcbiAgICAgIFNjZW5lLmR1cmF0aW9uKGdldEhlaWdodCgpKVxuICAgICAgcHJldmlvdXNIZWlnaHQgPSBnZXRIZWlnaHQoKVxuICAgIH1cblxuICAgIGNvbnN0IGZuID0gKCkgPT4ge1xuICAgICAgLyogc2V0IGR1cmF0aW9uIHRvIG1hdGNoIGhlaWdodCBvZiBlbGVtZW50ICovXG4gICAgICBjdXJyZW50SGVpZ2h0ID0gZ2V0SGVpZ2h0KClcblxuICAgICAgaWYgKGN1cnJlbnRIZWlnaHQgIT09IHByZXZpb3VzSGVpZ2h0KSB7XG4gICAgICAgIHVwZGF0ZSgpXG4gICAgICB9XG4gICAgfVxuXG4gICAgZm4oKVxuXG4gICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3Jlc2l6ZScsIHRocm90dGxlKGZuLCA3MDApKVxuXG4gICAgY3VycmVudEhlaWdodCA9IGdldEhlaWdodCgpXG5cbiAgICB1cGRhdGUoKVxuICB9IGVsc2UgaWYgKGlzT2JqZWN0KGR1cmF0aW9uKSkge1xuICAgIC8qIGlmIGFuIG9iamVjdCwgbWFrZSBicmVha3BvaW50cyAqL1xuICAgIGNvbnN0IGtleXMgPSBPYmplY3Qua2V5cyhkdXJhdGlvbikucmV2ZXJzZSgpXG5cbiAgICBjb25zdCBmbiA9ICgpID0+IHtcbiAgICAgIGZvciAobGV0IGluZGV4ID0gMDsgaW5kZXggPCBrZXlzLmxlbmd0aDsgaW5kZXgrKykge1xuICAgICAgICBjb25zdCBicmVha3BvaW50ID0gcGFyc2VGbG9hdChrZXlzW2luZGV4XSlcblxuICAgICAgICBpZiAoYnJlYWtwb2ludCA8PSB3aW5kb3cuaW5uZXJXaWR0aCkge1xuICAgICAgICAgIFNjZW5lLmR1cmF0aW9uKGR1cmF0aW9uW2JyZWFrcG9pbnRdKVxuICAgICAgICAgIGJyZWFrXG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG5cbiAgICBmbigpXG5cbiAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigncmVzaXplJywgdGhyb3R0bGUoZm4sIDcwMCkpXG4gIH0gZWxzZSB7XG4gICAgLyogbm90aGluZyBvZiB0aGUgYWJvdmU/IGp1c3Qgc2V0IGl0ICovXG4gICAgU2NlbmUuZHVyYXRpb24oZHVyYXRpb24pXG4gIH1cbn1cblxuY29uc3Qgc2V0Q2xhc3NOYW1lID0gKFNjZW5lLCBvcHRpb25zLCBkdXJhdGlvbikgPT4ge1xuICBjb25zdCB0b2dnbGUgPSB7XG4gICAgY2xhc3NOYW1lOiBudWxsLFxuICAgIGVsZW1lbnQ6IG51bGwsXG4gICAgcmV2ZXJzZTogZmFsc2UsXG4gICAgLi4ub3B0aW9ucyxcbiAgfVxuXG4gIGlmICghdG9nZ2xlLmNsYXNzTmFtZSkge1xuICAgIGVycm9yTG9nKG5hbWVTcGFjZSwgYEJlIHN1cmUgdG8gc2V0IGEgY2xhc3NOYW1lIGluIHRoZSBuZXcgJHtuYW1lU3BhY2V9KHsgdG9nZ2xlOiB7IGNsYXNzTmFtZTogXCJteS1jbGFzc1wiIH0gfSlgKVxuICB9XG5cbiAgaWYgKCF0b2dnbGUuZWxlbWVudCkge1xuICAgIGVycm9yTG9nKFxuICAgICAgbmFtZVNwYWNlLFxuICAgICAgYEJlIHN1cmUgdG8gc2V0IGEgY29uc3QgdG9nZ2xlRWxlbWVudCA9IChyZWFjdFJlZi5jdXJyZW50IG9yIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IpIGluIHRoZSBuZXcgJHtuYW1lU3BhY2V9KHsgdG9nZ2xlOiB7IGVsZW1lbnQ6IHRvZ2dsZUVsZW1lbnQgfSB9KWAsXG4gICAgKVxuICB9XG5cbiAgY29uc3QgYWRkQ2xhc3NOYW1lID0gKCkgPT5cbiAgICAhdG9nZ2xlLmVsZW1lbnQuY2xhc3NMaXN0LmNvbnRhaW5zKHRvZ2dsZS5jbGFzc05hbWUpICYmIHRvZ2dsZS5lbGVtZW50LmNsYXNzTGlzdC5hZGQodG9nZ2xlLmNsYXNzTmFtZSlcblxuICBjb25zdCByZW1vdmVDbGFzc05hbWUgPSAoKSA9PlxuICAgIHRvZ2dsZS5lbGVtZW50LmNsYXNzTGlzdC5jb250YWlucyh0b2dnbGUuY2xhc3NOYW1lKSAmJiB0b2dnbGUuZWxlbWVudC5jbGFzc0xpc3QucmVtb3ZlKHRvZ2dsZS5jbGFzc05hbWUpXG5cbiAgU2NlbmUub24oJ2VudGVyJywgZnVuY3Rpb24oKSB7XG4gICAgYWRkQ2xhc3NOYW1lKClcbiAgfSlcblxuICBTY2VuZS5vbignYWRkJywgZnVuY3Rpb24oKSB7XG4gICAgaWYgKFNjZW5lLnN0YXRlKCkgPT09ICdEVVJJTkcnKSB7XG4gICAgICBhZGRDbGFzc05hbWUoKVxuICAgIH1cbiAgfSlcblxuICBTY2VuZS5vbignbGVhdmUnLCBmdW5jdGlvbihldmVudCkge1xuICAgIGlmICghdG9nZ2xlLnJldmVyc2UgJiYgZHVyYXRpb24pIHtcbiAgICAgIC8vIG5lZWRzIHRvIGJlIGJhc2VkIG9uIHdoZXRoZXIgb3Igbm90IHdlIGhhdmUgYSBkdXJhdGlvblxuICAgICAgZXZlbnQuc2Nyb2xsRGlyZWN0aW9uID09PSAnUkVWRVJTRScgJiYgcmVtb3ZlQ2xhc3NOYW1lKClcbiAgICB9IGVsc2Uge1xuICAgICAgcmVtb3ZlQ2xhc3NOYW1lKClcbiAgICB9XG4gIH0pXG5cbiAgU2NlbmUub24oJ3JlbW92ZScsIGZ1bmN0aW9uKCkge1xuICAgIHJlbW92ZUNsYXNzTmFtZSgpXG4gIH0pXG59XG5cbmNvbnN0IHNldFR3ZWVuID0gKFNjZW5lLCBvcHRpb25zKSA9PiB7XG4gIGNvbnN0IGdzYXAgPSB7XG4gICAgZm9yd2FyZFNwZWVkOiAxLFxuICAgIHJldmVyc2VTcGVlZDogMSxcbiAgICB0aW1lbGluZTogbnVsbCxcbiAgICAuLi5vcHRpb25zLFxuICB9XG5cbiAgaWYgKCFnc2FwLnRpbWVsaW5lKSB7XG4gICAgZXJyb3JMb2coXG4gICAgICBuYW1lU3BhY2UsXG4gICAgICBgQmUgc3VyZSB0byBzZXQgYSBjb25zdCB0bCA9IGdzYXAudGltZWxpbmUoeyBwYXVzZWQ6IHRydWUgfSkgaW4gdGhlIG5ldyAke25hbWVTcGFjZX0oeyBnc2FwOiB7IHRpbWVsaW5lOiB0bCB9IH0pYCxcbiAgICApXG4gIH1cblxuICBTY2VuZS5vbigncHJvZ3Jlc3MnLCBmdW5jdGlvbigpIHtcbiAgICB1cGRhdGVUd2VlblByb2dyZXNzKFNjZW5lLCBnc2FwLnRpbWVsaW5lLCBnc2FwLmZvcndhcmRTcGVlZCwgZ3NhcC5yZXZlcnNlU3BlZWQpXG4gIH0pXG5cbiAgU2NlbmUub24oJ3JlbW92ZScsIGZ1bmN0aW9uKCkge1xuICAgIHJlbW92ZVR3ZWVuKGdzYXAudGltZWxpbmUpXG4gIH0pXG59XG5cbmludGVyZmFjZSBJU2Nyb2xsU2NlbmVUb2dnbGUgZXh0ZW5kcyBJU2Nyb2xsT2JzZXJ2ZXJUb2dnbGUge1xuICAvKipcbiAgICogcmV2ZXJzZVxuICAgKiBAZGVzYyBTcGVjaWZ5IHRoZSBjbGFzc05hbWUgc2hvdWxkIGJlIHJlbW92ZWQgYWZ0ZXIgdGhlIGR1cmF0aW9uIG9mIHNjZW5lIGlzIG1ldC4gT25seSBhcHBsaWVzIGlmIHNjZW5lIGhhcyBkdXJhdGlvbi5cbiAgICogQHR5cGUgYm9vbGVhblxuICAgKiBAZGVmYXVsdCBmYWxzZVxuICAgKiBAZXhhbXBsZVxuICAgKiB0b2dnbGU6IHsgcmV2ZXJzZTogdHJ1ZSB9XG4gICAqL1xuICByZXZlcnNlPzogYm9vbGVhblxufVxuXG5pbnRlcmZhY2UgSVNjcm9sbFNjZW5lIHtcbiAgLyoqXG4gICAqIGJyZWFrcG9pbnRzXG4gICAqIEBkZXNjIFVzZSB0byBzZXQgcmVzcG9uc2l2ZW5lc3Mgb2YgdGhlIG5ldyBTY3JvbGxNYWdpYy5TY2VuZSwgbW9iaWxlLWZpcnN0XG4gICAqIEB0eXBlIG9iamVjdFxuICAgKiBAZXhhbXBsZVxuICAgKiBicmVha3BvaW50czogeyAwOiBmYWxzZSwgNzY4OiB0cnVlIH1cbiAgICovXG4gIGJyZWFrcG9pbnRzPzogb2JqZWN0XG5cbiAgLyoqXG4gICAqIGNvbnRyb2xsZXJcbiAgICogQGRlc2MgRXh0cmEgb3B0aW9ucyB0byBwYXNzIHRoZSBuZXcgU2Nyb2xsTWFnaWMuQ29udHJvbGxlciwgbGlrZSB2ZXJ0aWNhbCwgZXRjLlxuICAgKiBAdHlwZSBvYmplY3RcbiAgICogQGV4YW1wbGVcbiAgICogY29udHJvbGxlcjogeyB2ZXJ0aWNhbDogZmFsc2UgfVxuICAgKi9cbiAgY29udHJvbGxlcj86IG9iamVjdFxuXG4gIC8qKlxuICAgKiBkdXJhdGlvblxuICAgKiBAZGVzYyBVc2UgdG8gc2V0IHJlc3BvbnNpdmVuZXNzIG9mIHRoZSBuZXcgU2Nyb2xsTWFnaWMuU2NlbmUsIG1vYmlsZS1maXJzdCAoaWYgc2V0dGluZyBicmVha3BvaW50cylcbiAgICogTXVzdCBiZSBzdHJpbmcgZm9yIHBlcmNlbnRhZ2UsIGFuZCBudW1iZXIgZm9yIHBpeGVsLlxuICAgKiBAdHlwZSBvYmplY3RcbiAgICogQGV4YW1wbGVcbiAgICogZHVyYXRpb246ICcxMDAlJyA9IDEwMHZoXG4gICAqIGR1cmF0aW9uOiAxMDAgPSAxMDBweFxuICAgKiBkdXJhdGlvbjogeyAwOiAnNTAlJywgNzY4OiAnMTAwJSB9IC8vID0gU2Nyb2xsU2NlbmUgbGFzdHMgNTB2aCBvbiBtb2JpbGUsIDEwMCUgYWZ0ZXJcbiAgICovXG4gIGR1cmF0aW9uPzogc3RyaW5nIHwgbnVtYmVyIHwgb2JqZWN0XG5cbiAgLyoqXG4gICAqIGdzYXBcbiAgICogQGRlc2MgVXNlIHRvIHNldCBvcHRpb25zIGZvciB0aGUgZ3NhcCBhbmltYXRpb24gb2YgdGhlIFNjcm9sbE9ic2VydmVyLlxuICAgKiBAdHlwZSBvYmplY3RcbiAgICogQGV4YW1wbGVcbiAgICogZ3NhcDogeyB0aW1lbGluZTogbXlUaW1lbGluZSwgeW95bzogdHJ1ZSwgcmV2ZXJzZVNwZWVkOiAyIH1cbiAgICovXG4gIGdzYXA/OiBJU2Nyb2xsT2JzZXJ2ZXJHc2FwXG5cbiAgLyoqXG4gICAqIHRyaWdnZXJIb29rXG4gICAqIEBkZXNjIFNldCB0aGUgb2Zmc2V0IG9mIHRoZSBTY3JvbGxNYWdpYyBzY2VuZS5cbiAgICogQHR5cGUgIG51bWJlciB8IHN0cmluZ1xuICAgKiBAZGVmYXVsdHZhbHVlIDBcbiAgICogQGV4YW1wbGVcbiAgICogb2Zmc2V0OiAxMDBcbiAgICogb2Zmc2V0OiAnMTAlJ1xuICAgKi9cbiAgb2Zmc2V0PzogbnVtYmVyIHwgc3RyaW5nXG5cbiAgLyoqXG4gICAqIHNjZW5lXG4gICAqIEBkZXNjIEV4dHJhIG9wdGlvbnMgdG8gcGFzcyB0aGUgbmV3IFNjcm9sbE1hZ2ljLlNjZW5lLCBsaWtlIGxvZ0xldmVsLCBldGMuXG4gICAqIEB0eXBlIG9iamVjdFxuICAgKiBAZXhhbXBsZVxuICAgKiBzY2VuZTogeyBsb2dMZXZlbDogMiB9XG4gICAqL1xuICBzY2VuZT86IG9iamVjdFxuXG4gIC8qKlxuICAgKiB0b2dnbGVcbiAgICogQGRlc2MgVXNlIHRvIHNldCB0aGUgb3B0aW9ucyBmb3IgdGhlIHRvZ2dsaW5nIG9mIGEgY2xhc3NOYW1lXG4gICAqIEB0eXBlIG9iamVjdFxuICAgKiBAZXhhbXBsZVxuICAgKiB0b2dnbGU6IHsgZWxlbWVudDogY29udGFpbmVyUmVmLmN1cnJlbnQsIGNsYXNzTmFtZTogJ2xldHMtZG8tdGhpcycgfVxuICAgKi9cbiAgdG9nZ2xlPzogSVNjcm9sbFNjZW5lVG9nZ2xlXG5cbiAgLyoqXG4gICAqIHRyaWdnZXJFbGVtZW50XG4gICAqIEBkZXNjIFNldCB0aGUgZWxlbWVudCB5b3Ugd2lzaCB0byB0cmlnZ2VyIGV2ZW50cyBiYXNlZCB1cG9uLCB0aGUgb2JzZXJ2ZWQgZWxlbWVudC5cbiAgICogQHR5cGUgIEhUTUxFbGVtZW50IHwgYW55XG4gICAqIEBleGFtcGxlXG4gICAqIHRyaWdnZXJFbGVtZW50OiB0cmlnZ2VyUmVmLmN1cnJlbnRcbiAgICovXG4gIHRyaWdnZXJFbGVtZW50OiBIVE1MRWxlbWVudCB8IGFueVxuXG4gIC8qKlxuICAgKiB0cmlnZ2VySG9va1xuICAgKiBAZGVzYyBTZXQgdGhlIHRyaWdnZXJIb29rIG9mIHRoZSBTY3JvbGxNYWdpYyBzY2VuZS5cbiAgICogQHR5cGUgIG51bWJlclxuICAgKiBAZGVmYXVsdHZhbHVlICdvbkVudGVyJ1xuICAgKiBAZXhhbXBsZVxuICAgKiB0cmlnZ2VySG9vazogMC41XG4gICAqL1xuICB0cmlnZ2VySG9vaz86IG51bWJlciB8IHN0cmluZ1xuXG4gIC8qKlxuICAgKiB1c2VHbG9iYWxDb250cm9sbGVyXG4gICAqIEBkZXNjIENob3NlIHdoZXRoZXIgb3Igbm90IHRvIHVzZSB0aGUgZ2xvYmFsQ29udHJvbGxlciBwcm92aWRlZCBmb3IgeW91LCBvciBhIGZyZXNoIG5ldyBTY3JvbGxNYWdpYy5Db250cm9sbGVyIGluc3RhbmNlLlxuICAgKiBAdHlwZSBib29sZWFuXG4gICAqIEBkZWZhdWx0VmFsdWUgdHJ1ZVxuICAgKiBAZXhhbXBsZVxuICAgKiB1c2VHbG9iYWxDb250cm9sbGVyOiBmYWxzZVxuICAgKi9cbiAgdXNlR2xvYmFsQ29udHJvbGxlcj86IGJvb2xlYW5cbn1cblxuLy8gYWRkIGNvbnRyb2xsZXIgdmFyXG5sZXQgZ2xvYmFsQ29udHJvbGxlclxuXG5jb25zdCBTY3JvbGxTY2VuZSA9IGZ1bmN0aW9uKFxuICB0aGlzOiBhbnksXG4gIHtcbiAgICBicmVha3BvaW50cyxcbiAgICBjb250cm9sbGVyID0ge30sXG4gICAgZHVyYXRpb24sXG4gICAgZ3NhcCxcbiAgICBvZmZzZXQgPSAwLFxuICAgIHNjZW5lID0ge30sXG4gICAgdG9nZ2xlLFxuICAgIHRyaWdnZXJFbGVtZW50LFxuICAgIHRyaWdnZXJIb29rID0gJ29uRW50ZXInLFxuICAgIHVzZUdsb2JhbENvbnRyb2xsZXIgPSB0cnVlLFxuICB9OiBJU2Nyb2xsU2NlbmUsXG4pIHtcbiAgbGV0IGxvY2FsQ29udHJvbGxlclxuXG4gIC8vIGNoZWNrIGlmIHVzaW5nIGEgbG9jYWwgY29udHJvbGxlclxuICBpZiAoIXVzZUdsb2JhbENvbnRyb2xsZXIpIHtcbiAgICBsb2NhbENvbnRyb2xsZXIgPSBuZXcgU2Nyb2xsTWFnaWMuQ29udHJvbGxlcihjb250cm9sbGVyKVxuICB9XG5cbiAgLy8gbW91bnQgY29udHJvbGxlclxuICBpZiAoIWdsb2JhbENvbnRyb2xsZXIgJiYgdXNlR2xvYmFsQ29udHJvbGxlcikge1xuICAgIGdsb2JhbENvbnRyb2xsZXIgPSBuZXcgU2Nyb2xsTWFnaWMuQ29udHJvbGxlcihjb250cm9sbGVyKVxuICB9XG5cbiAgY29uc3QgY29udHJvbGxlcklzVXNlID0gbG9jYWxDb250cm9sbGVyID8gbG9jYWxDb250cm9sbGVyIDogZ2xvYmFsQ29udHJvbGxlclxuXG4gIGlmICghdHJpZ2dlckVsZW1lbnQpIHtcbiAgICBlcnJvckxvZyhcbiAgICAgIG5hbWVTcGFjZSxcbiAgICAgIGBCZSBzdXJlIHRvIHNldCBhIGNvbnN0IHRyaWdnZXJFbGVtZW50ID0gKHJlYWN0UmVmLmN1cnJlbnQgb3IgZG9jdW1lbnQucXVlcnlTZWxlY3RvcikgaW4gdGhlIG5ldyAke25hbWVTcGFjZX0oeyB0cmlnZ2VyRWxlbWVudDogdHJpZ2dlckVsZW1lbnQgfSkuYCxcbiAgICApXG4gIH1cblxuICBjb25zdCBTY2VuZSA9IG5ldyBTY3JvbGxNYWdpYy5TY2VuZSh7XG4gICAgdHJpZ2dlckVsZW1lbnQsXG4gICAgdHJpZ2dlckhvb2ssXG4gICAgb2Zmc2V0LFxuICAgIC4uLnNjZW5lLFxuICB9KVxuXG4gIGlmIChkdXJhdGlvbikge1xuICAgIHNldER1cmF0aW9uKFNjZW5lLCBkdXJhdGlvbilcbiAgfVxuXG4gIGlmICh0b2dnbGUgJiYgaXNPYmplY3QodG9nZ2xlKSkge1xuICAgIHNldENsYXNzTmFtZShTY2VuZSwgdG9nZ2xlLCBkdXJhdGlvbilcbiAgfVxuXG4gIGlmIChnc2FwICYmIGlzT2JqZWN0KGdzYXApKSB7XG4gICAgc2V0VHdlZW4oU2NlbmUsIGdzYXApXG4gIH1cblxuICB0aGlzLmluaXQgPSBmdW5jdGlvbigpIHtcbiAgICBjb250cm9sbGVySXNVc2UgJiYgU2NlbmUuYWRkVG8oY29udHJvbGxlcklzVXNlKVxuICB9XG5cbiAgdGhpcy5kZXN0cm95ID0gZnVuY3Rpb24oKSB7XG4gICAgU2NlbmUucmVtb3ZlKClcbiAgfVxuXG4gIHRoaXMuU2NlbmUgPSBTY2VuZVxuICB0aGlzLkNvbnRyb2xsZXIgPSBjb250cm9sbGVySXNVc2VcblxuICBzY3JvbGxBbmltYXRpb25Jbml0KGJyZWFrcG9pbnRzLCB0aGlzLmluaXQsIHRoaXMuZGVzdHJveSlcbn1cblxuZXhwb3J0IHsgU2Nyb2xsU2NlbmUgfVxuIl19